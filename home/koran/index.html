<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Image Overlay Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        /* CSS yang sama persis seperti sebelumnya, tidak ada perubahan di sini */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0;
            min-height: 70vh;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
        }

        .zoom-controls {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .zoom-btn {
            padding: 8px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .zoom-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        #zoomLevel {
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }

        #zoomSlider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }

        #zoomSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }

        #zoomSlider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
        }

        .canvas-area {
            padding: 30px;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 600px;
            overflow: auto;
        }

        .control-group {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }

        .control-group h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group h3:before {
            content: "‚öôÔ∏è";
            font-size: 1rem;
        }

        .file-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: block;
            padding: 12px 20px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
        }

        .file-input-label:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #34495e;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .position-display {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
            transform: translateY(-2px);
        }

        #canvas-container {
            border: 3px solid #e9ecef;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: #ffffff;
            overflow: hidden;
        }

        .canvas-placeholder {
            width: 800px;
            height: 600px;
            border: 2px dashed #bdc3c7;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #7f8c8d;
            font-size: 18px;
            background: linear-gradient(45deg, #f8f9fa 25%, transparent 25%), 
                                 linear-gradient(-45deg, #f8f9fa 25%, transparent 25%), 
                                 linear-gradient(45deg, transparent 75%, #f8f9fa 75%), 
                                 linear-gradient(-45deg, transparent 75%, #f8f9fa 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .canvas-placeholder .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .status-bar {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .instructions {
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #0c5460;
            font-size: 14px;
            line-height: 1.5;
        }

        .instructions strong {
            color: #0c5460;
        }

        /* NEW CSS for radio buttons */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            color: #34495e;
        }

        .radio-group input[type="radio"] {
            margin-right: 8px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #ccc;
            border-radius: 50%;
            outline: none;
            transition: all 0.2s ease;
        }

        .radio-group input[type="radio"]:checked {
            background-color: #3498db;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }

        .radio-group input[type="radio"]:hover {
            border-color: #3498db;
        }


        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            
            .canvas-placeholder {
                width: 100%;
                max-width: 600px;
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .sidebar, .canvas-area {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Simple Overlay Tool</h1>
            <p>Drag and drop image overlay with millimeter precision</p>
        </div>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="instructions">
                    <strong>How to use:</strong><br>
                    1. Select background Media and Size<br>
                    2. Upload overlay image<br>
                    3. Drag overlay to position<br>
                    4. Download merged result (auto 500% zoom for hi-res)
                </div>

                <div class="control-group">
                    <h3>Image Upload</h3>
                    <div class="input-group">
                        <label for="mediaSelect">üì∞ Select Media</label>
                        <select id="mediaSelect">
                            </select>
                    </div>
                    <div class="input-group">
                        <label for="sizeSelect">üìê Select Size</label>
                        <select id="sizeSelect">
                            </select>
                    </div>
                    <div class="file-input-wrapper">
                        <input type="file" id="overlayInput" class="file-input" accept="image/*">
                        <label for="overlayInput" class="file-input-label">üñºÔ∏è Upload Overlay</label>
                    </div>
                </div>

                <div class="control-group">
                    <h3>DPI Settings</h3>
                    <div class="input-group">
                        <label for="dpiInput">DPI (Dots Per Inch)</label>
                        <input type="number" id="dpiInput" value="300" min="72" max="1200">
                    </div>
                </div>

                <div class="control-group">
                    <h3>Zoom Control</h3>
                    <div class="zoom-controls">
                        <button id="zoomOutBtn" class="zoom-btn">üîç-</button>
                        <span id="zoomLevel">100%</span>
                        <button id="zoomInBtn" class="zoom-btn">üîç+</button>
                        <button id="zoomFitBtn" class="zoom-btn">‚èπÔ∏è</button>
                    </div>
                    <div class="input-group">
                        <input type="range" id="zoomSlider" min="25" max="500" value="100" step="25">
                    </div>
                </div>

                <div class="control-group">
                    <h3>Overlay Dimensions (mm)</h3>
                    <div class="position-display">
                        <div>Width: <span id="overlayWidthMm">0.0</span> mm</div>
                        <div>Height: <span id="overlayHeightMm">0.0</span> mm</div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Download Quality</h3>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="downloadQuality" value="1" checked> Small (100%)
                        </label>
                        <label>
                            <input type="radio" name="downloadQuality" value="3"> Medium (300%)
                        </label>
                        <label>
                            <input type="radio" name="downloadQuality" value="5"> Large (500%)
                        </label>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Actions</h3>
                    <div class="action-buttons">
                        <button id="downloadBtn" class="btn-primary">üíæ Download Merged Image</button>
                        <button id="resetBtn" class="btn-secondary">üîÑ Reset Overlay Position</button>
                    </div>
                </div>
            </div>

            <div class="canvas-area">
                <div id="canvas-container">
                    <div class="canvas-placeholder">
                        <div class="icon">üñºÔ∏è</div>
                        <div>Loading background image...</div>
                        <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                            Select background media and size, then upload overlay
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div id="statusText">Ready - Select background and upload overlay</div>
            <div id="canvasSize">Canvas: Not loaded</div>
        </div>
    </div>

    <script>
        class SimpleOverlayTool {
            constructor() {
                this.canvas = null;
                this.dpi = 300;
                this.mmToPixel = this.dpi / 25.4; // 25.4mm per inch
                this.backgroundImg = null;
                this.overlayImg = null;
                this.zoomLevel = 1;
                this.originalCanvasSize = { width: 0, height: 0 };
                this.downloadZoomOption = 1; // Default to 100% (Small)
                
                // --- NEW CONFIGURATION ---
                // Di dalam class SimpleOverlayTool, cari bagian constructor atau properti this.config
                this.config = {
                    mediaOptions: [
                        "Bali", "Bangka", "Banjarmasin", "Batam", "Belitung", "Jabar",
                        "Jambi", "Jateng", "Jogja", "Kaltim", "Kupang", "Lampung",
                        "Manado", "Medan", "Pekanbaru", "Pontianak", "Serambi",
                        "Sripo", "Sumsel", "SuperBall", "Surya", "Wartakota", "Timur" 
                    ],
                    sizeOptions: [
                        "2x100", "3x200", "3x270", "4x270", "Setengah_Halaman", "Full_Page_Dalam", "Full_Page_Cover"
                    ],
                    defaultMedia: "Bali",
                    defaultSize: "2x100"
                };
                this.initializeEventListeners();
                this.initializeCanvas();
                this.populateDropdowns(); // Populate dropdowns first
                this.loadDefaultBackgroundImage(); // Then load default background
            }

            initializeEventListeners() {
                // Background select dropdowns
                document.getElementById('mediaSelect').addEventListener('change', () => this.loadSelectedBackgroundImage());
                document.getElementById('sizeSelect').addEventListener('change', () => this.loadSelectedBackgroundImage());
                
                // Overlay input
                document.getElementById('overlayInput').addEventListener('change', (e) => this.loadOverlayImage(e));
                
                // DPI input
                document.getElementById('dpiInput').addEventListener('change', (e) => this.updateDPI(e));
                
                // Zoom controls
                document.getElementById('zoomInBtn').addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOutBtn').addEventListener('click', () => this.zoomOut());
                document.getElementById('zoomFitBtn').addEventListener('click', () => this.zoomToFit());
                document.getElementById('zoomSlider').addEventListener('input', (e) => this.setZoom(e.target.value));
                
                // Action buttons
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadMergedImage());
                // Event listener untuk addRectangleBtn telah dihapus
                document.getElementById('resetBtn').addEventListener('click', () => this.resetOverlayPosition());

                // NEW: Download Quality Radio Buttons
                document.querySelectorAll('input[name="downloadQuality"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.downloadZoomOption = parseFloat(e.target.value);
                        this.updateStatus(`Download quality set to ${e.target.labels[0].textContent.trim().split(' ')[0]}`);
                    });
                });
            }

            initializeCanvas() {
                const placeholder = document.querySelector('.canvas-placeholder');
                if (placeholder) {
                    placeholder.style.display = 'flex';
                }
            }

            createCanvas(width, height) {
                const container = document.getElementById('canvas-container');
                container.innerHTML = '';
                
                const canvasElement = document.createElement('canvas');
                canvasElement.id = 'fabricCanvas';
                container.appendChild(canvasElement);
                
                this.originalCanvasSize = { width, height };
                
                this.canvas = new fabric.Canvas('fabricCanvas', {
                    width: width,
                    height: height,
                    backgroundColor: '#ffffff'
                });
                
                // Enable object controls and update position display
                this.canvas.on('object:moving', () => this.updatePositionDisplay());
                this.canvas.on('object:moved', () => this.updatePositionDisplay());
                this.canvas.on('object:scaling', () => this.updatePositionDisplay()); // Added for scaling
                this.canvas.on('object:scaled', () => this.updatePositionDisplay()); // Added for scaling
                this.canvas.on('selection:created', () => this.updatePositionDisplay());
                this.canvas.on('selection:updated', () => this.updatePositionDisplay());
                this.canvas.on('selection:cleared', () => this.updatePositionDisplay()); // Added for cleared selection
                
                this.updateCanvasSize(width, height);
                this.updateZoomDisplay();
            }

            // --- NEW DROPDOWN POPULATION ---
            populateDropdowns() {
                const mediaSelect = document.getElementById('mediaSelect');
                const sizeSelect = document.getElementById('sizeSelect');

                // Populate Media dropdown
                this.config.mediaOptions.forEach(media => {
                    const option = document.createElement('option');
                    option.value = media;
                    option.textContent = media;
                    mediaSelect.appendChild(option);
                });
                // Set default selected value for Media
                mediaSelect.value = this.config.defaultMedia;

                // Populate Size dropdown
                this.config.sizeOptions.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size;
                    option.textContent = size;
                    sizeSelect.appendChild(option);
                });
                // Set default selected value for Size
                sizeSelect.value = this.config.defaultSize;
            }

            loadDefaultBackgroundImage() {
                this.loadSelectedBackgroundImage(); // This will use the default values set in populateDropdowns
            }

            loadSelectedBackgroundImage() {
                const media = document.getElementById('mediaSelect').value;
                const size = document.getElementById('sizeSelect').value;
                
                // Construct the image path based on the selected media and size
                // Assuming images are in a folder named 'images' and then subfolders by Media, like 'images/Bali/Bali_2x100.jpg'
                const imageSrc = `images/${media}/${media}_${size}.jpg`;
                
                this.loadImageAsBackground(imageSrc, `${media} ${size}`);
            }

            loadImageAsBackground(imageSrc, imageNameDisplay = "") {
                const placeholder = document.querySelector('.canvas-placeholder');
                if (placeholder) {
                    placeholder.style.display = 'flex';
                    placeholder.querySelector('div:nth-child(2)').textContent = 'Loading background image...';
                }

                fabric.Image.fromURL(imageSrc, (img) => {
                    const maxWidth = 1000;
                    const maxHeight = 700;
                    const scale = Math.min(maxWidth / img.width, maxHeight / img.height);
                    
                    const scaledWidth = img.width * scale;
                    const scaledHeight = img.height * scale;
                    
                    this.createCanvas(scaledWidth, scaledHeight);
                    
                    img.set({
                        left: 0,
                        top: 0,
                        selectable: false,
                        evented: false,
                        scaleX: scale,
                        scaleY: scale
                    });
                    
                    this.canvas.add(img);
                    this.canvas.sendToBack(img);
                    this.backgroundImg = img;
                    
                    // Re-add overlay if it exists
                    if (this.overlayImg) {
                        const centerX = this.canvas.width / 2;
                        const centerY = this.canvas.height / 2;
                        
                        // We need to re-scale the overlay based on the new canvas size
                        // A simpler approach for this example is to reset its scale to fit
                        // or just keep its current scale and recenter. Let's recenter for now.
                        this.overlayImg.set({
                            left: centerX - (this.overlayImg.width * this.overlayImg.scaleX) / 2,
                            top: centerY - (this.overlayImg.height * this.overlayImg.scaleY) / 2,
                        });
                        this.canvas.add(this.overlayImg);
                        this.canvas.setActiveObject(this.overlayImg);
                    }
                    
                    if (placeholder) placeholder.style.display = 'none'; // Hide placeholder once background is loaded
                    this.updatePositionDisplay(); // Update display after loading background
                    this.updateStatus(`Background image loaded: ${imageNameDisplay || imageSrc.split('/').pop()} - ready for overlay`);
                    this.canvas.renderAll();
                }, { crossOrigin: 'anonymous' });
            }

            loadOverlayImage(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!this.canvas) {
                    alert('Please wait for the background image to load or select one.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    fabric.Image.fromURL(e.target.result, (img) => {
                        // Remove existing overlay
                        if (this.overlayImg) {
                            this.canvas.remove(this.overlayImg);
                        }
                        
                        // Scale overlay to reasonable size
                        const maxSize = Math.min(this.canvas.width, this.canvas.height) * 0.4;
                        const scale = Math.min(maxSize / img.width, maxSize / img.height);
                        
                        img.set({
                            left: this.canvas.width / 2 - (img.width * scale) / 2,
                            top: this.canvas.height / 2 - (img.height * scale) / 2,
                            scaleX: scale,
                            scaleY: scale,
                            selectable: true,
                            evented: true,
                            hasRotatingPoint: true,
                            borderColor: '#3498db',
                            cornerColor: '#3498db',
                            cornerSize: 12,
                            transparentCorners: false,
                            cornerStyle: 'circle'
                        });
                        
                        this.canvas.add(img);
                        this.canvas.setActiveObject(img);
                        this.overlayImg = img;
                        
                        this.updatePositionDisplay();
                        this.updateStatus('Overlay loaded - drag to position, resize with corners');
                    });
                };
                reader.readAsDataURL(file);
            }

            updateDPI(event) {
                this.dpi = parseInt(event.target.value);
                this.mmToPixel = this.dpi / 25.4;
                this.updatePositionDisplay();
                this.updateStatus(`DPI updated to ${this.dpi}`);
            }

            updatePositionDisplay() {
                const activeObject = this.canvas ? this.canvas.getActiveObject() : null;

                if (!activeObject) {
                    document.getElementById('overlayWidthMm').textContent = '0.0';
                    document.getElementById('overlayHeightMm').textContent = '0.0';
                    return;
                }
                
                // Get the scaled width and height of the active object
                const objectWidthPixels = activeObject.getScaledWidth();
                const objectHeightPixels = activeObject.getScaledHeight();

                // Convert to millimeters
                const widthMm = objectWidthPixels / this.mmToPixel;
                const heightMm = objectHeightPixels / this.mmToPixel;
                
                document.getElementById('overlayWidthMm').textContent = widthMm.toFixed(1);
                document.getElementById('overlayHeightMm').textContent = heightMm.toFixed(1);
            }

            resetOverlayPosition() {
                const activeObject = this.canvas ? this.canvas.getActiveObject() : null;

                if (!activeObject) {
                    alert('No object selected to reset position.');
                    return;
                }
                
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                
                activeObject.set({
                    left: centerX - (activeObject.width * activeObject.scaleX) / 2,
                    top: centerY - (activeObject.height * activeObject.scaleY) / 2,
                    angle: 0
                });
                
                this.canvas.renderAll();
                this.updatePositionDisplay();
                this.updateStatus('Selected object position reset to center');
            }

            downloadMergedImage() {
                if (!this.canvas) {
                    alert('No canvas to download');
                    return;
                }
                
                if (!this.backgroundImg) {
                    alert('Please load a background image first');
                    return;
                }
                
                // Deselect any selected objects for clean download
                this.canvas.discardActiveObject();
                this.canvas.renderAll();
                
                // Use the selected download zoom
                const downloadZoom = this.downloadZoomOption;
                
                // Create a temporary canvas with higher resolution
                const tempCanvas = new fabric.StaticCanvas(null, { // Use StaticCanvas for off-screen rendering
                    width: this.originalCanvasSize.width * downloadZoom,
                    height: this.originalCanvasSize.height * downloadZoom,
                    backgroundColor: '#ffffff'
                });
                
                // Clone all objects to the temporary canvas with scaled positions
                // Fabric.js clone method is asynchronous, so use Promise.all or a similar pattern
                const promises = this.canvas.getObjects().map(obj => {
                    return new Promise(resolve => {
                        obj.clone((cloned) => {
                            cloned.set({
                                left: obj.left * downloadZoom,
                                top: obj.top * downloadZoom,
                                scaleX: obj.scaleX * downloadZoom,
                                scaleY: obj.scaleY * downloadZoom,
                                // Important: Ensure original dimensions are used for scaling
                                // Fabric.js handles this mostly, but sometimes explicit checks are needed for complex objects
                            });
                            tempCanvas.add(cloned);
                            resolve();
                        });
                    });
                });
                
                Promise.all(promises).then(() => {
                    tempCanvas.renderAll();
                    
                    // Create download from the high-res canvas
                    const link = document.createElement('a');
                    const selectedMedia = document.getElementById('mediaSelect').value;
                    const selectedSize = document.getElementById('sizeSelect').value;
                    let qualityText = "";
                    if (downloadZoom === 1) qualityText = "Small";
                    else if (downloadZoom === 3) qualityText = "Medium";
                    else if (downloadZoom === 5) qualityText = "Large";

                    link.download = `merged-${selectedMedia}-${selectedSize}-${qualityText}-${new Date().getTime()}.png`;
                    link.href = tempCanvas.toDataURL('image/png', 1.0);
                    link.click();
                    
                    // Clean up temporary canvas
                    tempCanvas.dispose();
                    
                    this.updateStatus(`High-resolution merged image (${qualityText}) downloaded`);
                });
            }

            updateCanvasSize(width, height) {
                const widthMm = (width / this.mmToPixel).toFixed(1);
                const heightMm = (height / this.mmToPixel).toFixed(1);
                document.getElementById('canvasSize').textContent = `Canvas: ${width}√ó${height}px (${widthMm}√ó${heightMm}mm)`;
            }

            updateStatus(message) {
                document.getElementById('statusText').textContent = message;
            }

            // Zoom functionality (unchanged)
            zoomIn() {
                const newZoom = Math.min(this.zoomLevel * 1.25, 5);
                this.setZoomLevel(newZoom);
            }

            zoomOut() {
                const newZoom = Math.max(this.zoomLevel / 1.25, 0.25);
                this.setZoomLevel(newZoom);
            }

            zoomToFit() {
                if (!this.canvas) return;
                
                const containerWidth = document.getElementById('canvas-container').clientWidth;
                const containerHeight = document.getElementById('canvas-container').clientHeight;
                const scaleX = containerWidth / this.originalCanvasSize.width;
                const scaleY = containerHeight / this.originalCanvasSize.height;
                const scale = Math.min(scaleX, scaleY, 1);
                
                this.setZoomLevel(scale);
            }

            setZoom(value) {
                const zoomLevel = parseFloat(value) / 100;
                this.setZoomLevel(zoomLevel);
            }

            setZoomLevel(zoomLevel) {
                if (!this.canvas) return;
                
                this.zoomLevel = zoomLevel;
                
                const newWidth = this.originalCanvasSize.width * zoomLevel;
                const newHeight = this.originalCanvasSize.height * zoomLevel;
                
                this.canvas.setDimensions({
                    width: newWidth,
                    height: newHeight
                });
                
                this.canvas.setZoom(zoomLevel);
                this.canvas.renderAll();
                
                this.updateZoomDisplay();
                this.updateStatus(`Zoom level: ${Math.round(zoomLevel * 100)}%`);
            }

            updateZoomDisplay() {
                const percentage = Math.round(this.zoomLevel * 100);
                document.getElementById('zoomLevel').textContent = `${percentage}%`;
                document.getElementById('zoomSlider').value = percentage;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new SimpleOverlayTool();
        });
    </script>
</body>
</html>