<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tribunnews.com - HTML5 Banner Ad Preview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #0066B1;
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .upload-section {
            padding: 20px;
            background: #f0f8ff;
            border-bottom: 1px solid #ddd;
        }

        .upload-area {
            border: 2px dashed #0066B1;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            background: #f8f9ff;
            border-color: #db1f25;
        }

        .upload-area.dragover {
            background: #f0f8ff;
            border-color: #db1f25;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            color: #0066B1;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 14px;
            color: #666;
        }

        .file-input {
            display: none;
        }

        .preview-container {
            display: flex;
            height: 600px;
        }

        .files-panel {
            width: 300px;
            background: #fafafa;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .files-header {
            background: #0066B1;
            color: white;
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
        }

        .files-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .file-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid #ddd;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            font-size: 13px;
        }

        .file-item:hover {
            background: #f0f8ff;
            border-color: #0066B1;
        }

        .file-item.active {
            background: #0066B1;
            color: white;
            border-color: #0066B1;
        }

        .file-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            background: #0066B1;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .banner-sizes {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .size-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .size-btn:hover, .size-btn.active {
            background: #db1f25;
        }

        .preview-frame {
            flex: 1;
            border: none;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .banner-container {
            border: 1px solid #ddd;
            background: #f9f9f9;
            display: inline-block;
            position: relative;
        }

        .banner-frame {
            border: none;
            display: block;
        }

        .banner-info {
            position: absolute;
            top: -25px;
            left: 0;
            font-size: 11px;
            color: #666;
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        .controls {
            padding: 15px 20px;
            background: #f0f8ff;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background: #db1f25;
            color: white;
        }

        .btn-primary:hover {
            background: #b8181d;
        }

        .btn-secondary {
            background: #0066B1;
            color: white;
        }

        .btn-secondary:hover {
            background: #004d85;
        }

        .status {
            margin-left: auto;
            font-size: 12px;
            color: #7f8c8d;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 16px;
        }

        .empty-icon {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 15px;
        }

        .file-info {
            background: #f8f9fa;
            padding: 10px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #666;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #db1f25;
            width: 0;
            transition: width 0.3s;
        }

        @media (max-width: 768px) {
            .preview-container {
                flex-direction: column;
                height: auto;
            }
            
            .files-panel {
                width: 100%;
                max-height: 200px;
            }
            
            .preview-panel {
                min-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            Tribunnews.com - HTML5 Banner Ad Preview - Upload ZIP file
        </div>
        
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drop your ZIP file here or click to browse</div>
                <div class="upload-subtext">Supports ZIP files containing HTML5 banner ads</div>
                <div class="progress-bar" id="progressBar" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            <input type="file" class="file-input" id="fileInput" accept=".zip" />
        </div>
        
        <div class="preview-container">
            <div class="files-panel">
                <div class="files-header">
                    Files in ZIP
                </div>
                <div class="files-list" id="filesList">
                    <div class="empty-state">
                        <div class="empty-icon">üìÑ</div>
                        <div>No files loaded</div>
                    </div>
                </div>
                <div class="file-info" id="fileInfo" style="display: none;">
                    <div>Total files: <span id="totalFiles">0</span></div>
                    <div>ZIP size: <span id="zipSize">0 KB</span></div>
                </div>
            </div>
            
            <div class="preview-panel">
                <div class="preview-header">
                    <span id="previewTitle">Preview</span>
                    <div class="banner-sizes">
                        <span style="font-size: 12px; margin-right: 10px;">Common sizes:</span>
                        <button class="size-btn" data-size="728x90">728x90</button>
                        <button class="size-btn" data-size="300x250">300x250</button>
                        <button class="size-btn" data-size="160x600">160x600</button>
                        <button class="size-btn" data-size="320x50">320x50</button>
                        <button class="size-btn" data-size="custom">Custom</button>
                    </div>
                </div>
                <div class="preview-frame" id="previewFrame">
                    <div class="empty-state">
                        <div class="empty-icon">üñºÔ∏è</div>
                        <div>Select an HTML file to preview</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" id="refreshBtn" disabled>
                Refresh Preview
            </button>
            <button class="btn btn-secondary" id="clearBtn">
                Clear All
            </button>
            <button class="btn btn-secondary" id="downloadBtn" disabled>
                Download Current File
            </button>
            <!-- NEW BUTTON FOR WRAPPER DOWNLOAD -->
            <button class="btn btn-secondary" id="downloadWrapperBtn" disabled>
                Download Wrapper ZIP
            </button>
            <!-- END NEW BUTTON -->
            <button class="btn btn-secondary" id="fullscreenBtn" disabled>
                Fullscreen Preview
            </button>
            <div class="status" id="statusText">
                Ready - Upload a ZIP file to start
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        let currentZip = null;
        let currentFiles = {};
        let currentPreviewFile = null;
        let activeObjectUrls = []; 
        let currentZipName = ''; // Store the original ZIP name

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const filesList = document.getElementById('filesList');
        const previewFrame = document.getElementById('previewFrame');
        const previewTitle = document.getElementById('previewTitle');
        const statusText = document.getElementById('statusText');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const fileInfo = document.getElementById('fileInfo');
        const totalFiles = document.getElementById('totalFiles');
        const zipSize = document.getElementById('zipSize');

        // New button reference
        const downloadWrapperBtn = document.getElementById('downloadWrapperBtn');

        // Upload area events
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        // Button events
        document.getElementById('refreshBtn').addEventListener('click', refreshPreview);
        document.getElementById('clearBtn').addEventListener('click', clearAll);
        document.getElementById('downloadBtn').addEventListener('click', downloadCurrentFile);
        document.getElementById('fullscreenBtn').addEventListener('click', openFullscreen);
        
        // New button event
        downloadWrapperBtn.addEventListener('click', downloadWrapperZip);

        // Size buttons
        document.querySelectorAll('.size-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const size = btn.dataset.size;
                if (size === 'custom') {
                    const customSize = prompt('Enter custom size (WIDTHxHEIGHT):', '300x250');
                    if (customSize && customSize.match(/^\d+x\d+$/)) {
                        resizeBanner(customSize);
                    } else {
                        // Re-activate the previously active button or default
                        const currentActive = document.querySelector('.size-btn.active');
                        if (!currentActive) { 
                            document.querySelector('[data-size="300x250"]').classList.add('active');
                        }
                    }
                } else {
                    resizeBanner(size);
                }
            });
        });

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.zip')) {
                processZipFile(files[0]);
            } else {
                alert('Please upload a ZIP file');
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file && file.name.endsWith('.zip')) {
                processZipFile(file);
            } else {
                alert('Please select a ZIP file');
            }
        }

        async function processZipFile(file) {
            clearObjectUrls(); // Clear existing URLs before processing new ZIP
            currentZipName = file.name.replace('.zip', ''); // Store original name
            showProgress(true);
            statusText.textContent = 'Processing ZIP file...';
            
            try {
                const zip = new JSZip();
                const zipContent = await zip.loadAsync(file, { update: (metadata) => {
                    updateProgress(metadata.percent * 0.5); // Load progress 0-50%
                    statusText.textContent = `Loading: ${metadata.percent.toFixed(0)}%`;
                }});
                
                currentZip = zipContent;
                currentFiles = {};
                
                const files = [];
                // Collect all files first
                zipContent.forEach((relativePath, zipEntry) => {
                    if (!zipEntry.dir) {
                        files.push({
                            name: relativePath,
                            entry: zipEntry
                        });
                    }
                });

                // Extract content for each file
                let processedCount = 0;
                for (const fileData of files) {
                    const content = await fileData.entry.async('blob');
                    currentFiles[fileData.name] = {
                        name: fileData.name,
                        content: content,
                        type: getFileType(fileData.name),
                        size: content.size
                    };
                    processedCount++;
                    // Update progress more frequently for extraction phase
                    updateProgress(50 + (processedCount / files.length) * 50); // From 50% to 100%
                }

                displayFiles();
                updateFileInfo(files.length, file.size);
                statusText.textContent = `Loaded ${files.length} files from ZIP: ${currentZipName}`;
                
            } catch (error) {
                console.error('Error processing ZIP:', error);
                statusText.textContent = 'Error processing ZIP file';
                // Menggunakan pesan box kustom sebagai ganti alert()
                const errorMessage = 'Error processing ZIP file. Please check if it\'s a valid ZIP.';
                const customAlert = document.createElement('div');
                customAlert.style = "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background: white; border: 1px solid #db1f25; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000;";
                customAlert.innerHTML = `<strong>Error!</strong><p>${errorMessage}</p><button onclick="this.parentNode.remove()" style="margin-top: 10px; padding: 5px 10px; background: #db1f25; color: white; border: none; border-radius: 4px;">OK</button>`;
                document.body.appendChild(customAlert);
            } finally {
                showProgress(false);
            }
        }

        /**
         * Creates a new ZIP file that includes all original files 
         * plus a new '_wrapper.html' file.
         */
        async function downloadWrapperZip() {
            if (!currentZip || !currentPreviewFile) {
                // Menggunakan pesan box kustom sebagai ganti alert()
                const errorMessage = 'Please load a ZIP file and select an HTML file to create a wrapper.';
                const customAlert = document.createElement('div');
                customAlert.style = "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background: white; border: 1px solid #0066B1; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000;";
                customAlert.innerHTML = `<strong>Error!</strong><p>${errorMessage}</p><button onclick="this.parentNode.remove()" style="margin-top: 10px; padding: 5px 10px; background: #0066B1; color: white; border: none; border-radius: 4px;">OK</button>`;
                document.body.appendChild(customAlert);
                return;
            }

            // 1. Get the main HTML file's name
            const mainHtmlFileName = currentPreviewFile;

            // 2. Determine Banner Size (optional, but good practice to include in wrapper style)
            let bannerWidth = 300;
            let bannerHeight = 250;
            const bannerFrame = document.getElementById('bannerFrame');
            if (bannerFrame && bannerFrame.style.width) {
                bannerWidth = parseInt(bannerFrame.style.width);
                bannerHeight = parseInt(bannerFrame.style.height);
            }
            
            // 3. Define the HTML content for the wrapper
            // This wrapper HTML file will be placed directly in the root of the new ZIP.
            const wrapperHtmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banner Wrapper Preview</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            flex-direction: column;
        }
        .banner-container {
            width: ${bannerWidth}px;
            height: ${bannerHeight}px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid #ccc;
            background-color: white;
            position: relative;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        .info {
            margin-bottom: 15px;
            font-size: 14px;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="info">
        Wrapper HTML (Banner Size: ${bannerWidth}x${bannerHeight})
    </div>
    <div class="banner-container">
        <!-- The iframe loads the main banner file directly from the same folder -->
        <iframe src="./${mainHtmlFileName}"></iframe>
    </div>
</body>
</html>
`;
            
            // 4. Create a new JSZip instance and clone the content
            const newZip = new JSZip();
            
            // Iterate over all files in the currentZip and add them to the new zip
            currentZip.forEach((relativePath, zipEntry) => {
                if (!zipEntry.dir) {
                    // Use a temporary name for the file blob to avoid re-reading
                    const fileBlob = currentFiles[relativePath].content;
                    newZip.file(relativePath, fileBlob);
                }
            });

            // 5. Add the new wrapper HTML file
            const wrapperFileName = `${currentZipName}_wrapper.html`;
            newZip.file(wrapperFileName, wrapperHtmlContent);

            // 6. Generate the ZIP file
            statusText.textContent = 'Generating wrapper ZIP...';
            downloadWrapperBtn.disabled = true;

            try {
                const content = await newZip.generateAsync({ type: "blob" }, (metadata) => {
                    updateProgress(metadata.percent);
                    statusText.textContent = `Zipping: ${metadata.percent.toFixed(0)}%`;
                });

                // 7. Trigger the download
                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = `${currentZipName}_wrapped.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // 8. Clean up
                URL.revokeObjectURL(a.href); 
                statusText.textContent = `Wrapper ZIP downloaded: ${a.download}`;

            } catch (error) {
                console.error('Error generating wrapper ZIP:', error);
                statusText.textContent = 'Error generating wrapper ZIP.';
                // Menggunakan pesan box kustom sebagai ganti alert()
                const errorMessage = 'Error generating wrapper ZIP. See console for details.';
                const customAlert = document.createElement('div');
                customAlert.style = "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background: white; border: 1px solid #db1f25; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000;";
                customAlert.innerHTML = `<strong>Error!</strong><p>${errorMessage}</p><button onclick="this.parentNode.remove()" style="margin-top: 10px; padding: 5px 10px; background: #db1f25; color: white; border: none; border-radius: 4px;">OK</button>`;
                document.body.appendChild(customAlert);
            } finally {
                downloadWrapperBtn.disabled = false;
                showProgress(false);
            }
        }


        function showProgress(show) {
            progressBar.style.display = show ? 'block' : 'none';
            if (!show) {
                progressFill.style.width = '0%';
            }
        }

        function updateProgress(percent) {
            progressFill.style.width = percent + '%';
        }

        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const types = {
                'html': 'html',
                'htm': 'html',
                'js': 'javascript',
                'css': 'stylesheet',
                'png': 'image',
                'jpg': 'image',
                'jpeg': 'image',
                'gif': 'image',
                'svg': 'image',
                'json': 'data'
            };
            return types[ext] || 'file';
        }

        function getFileIcon(type) {
            const icons = {
                'html': 'üåê',
                'javascript': 'üìú',
                'stylesheet': 'üé®',
                'image': 'üñºÔ∏è',
                'data': 'üìä',
                'file': 'üìÑ'
            };
            return icons[type] || 'üìÑ';
        }

        function displayFiles() {
            const fileEntries = Object.values(currentFiles);
            
            if (fileEntries.length === 0) {
                filesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÑ</div>
                        <div>No files loaded</div>
                    </div>
                `;
                return;
            }

            filesList.innerHTML = fileEntries
                .sort((a, b) => {
                    // HTML files first, then alphabetically
                    if (a.type === 'html' && b.type !== 'html') return -1;
                    if (b.type === 'html' && a.type !== 'html') return 1;
                    return a.name.localeCompare(b.name);
                })
                .map(file => `
                    <div class="file-item" data-filename="${file.name}">
                        <span class="file-icon">${getFileIcon(file.type)}</span>
                        <span>${file.name}</span>
                    </div>
                `).join('');

            // Add click events
            document.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.file-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    const filename = item.dataset.filename;
                    previewFile(filename);
                });
            });

            // Auto-select first HTML file
            const firstHtmlFile = fileEntries.find(f => f.type === 'html');
            if (firstHtmlFile) {
                const firstHtmlItem = document.querySelector(`[data-filename="${firstHtmlFile.name}"]`);
                if (firstHtmlItem) {
                    firstHtmlItem.click();
                }
            }
        }

        async function previewFile(filename) {
            const file = currentFiles[filename];
            if (!file) return;

            clearObjectUrls(); // Clear previous object URLs
            currentPreviewFile = filename;
            previewTitle.textContent = `Preview: ${filename}`;

            // Check if the file being previewed is HTML
            const isHtml = file.type === 'html';

            if (isHtml) {
                try {
                    // Read HTML content as text
                    const htmlContent = await file.content.text();
                    
                    // 1. Create Object URLs for all assets
                    const htmlBlobURLs = {};
                    for (const key in currentFiles) {
                        const blob = currentFiles[key].content;
                        const blobUrl = URL.createObjectURL(blob);
                        activeObjectUrls.push(blobUrl); // Store for later revocation
                        htmlBlobURLs[key] = blobUrl;
                    }

                    let modifiedHtmlContent = htmlContent;
                    
                    // 2. Determine the base path (directory of the main HTML file)
                    const filePathParts = filename.split('/');
                    filePathParts.pop(); // Remove the filename itself
                    const basePath = filePathParts.join('/') + (filePathParts.length > 0 ? '/' : '');

                    // 3. Replace relative paths in the HTML with absolute Blob URLs
                    Object.keys(htmlBlobURLs).forEach(originalPath => {
                        // Calculate the relative path from the main HTML file to the asset
                        let relativePathToAsset = originalPath;
                        
                        // Simple logic for files in the same directory (most common case for banner index.html)
                        const fileNameOnly = originalPath.split('/').pop();
                        
                        // Escape special characters for regex replacement
                        const escapedFileName = fileNameOnly.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                        const escapedPath = originalPath.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');

                        // --- REPLACEMENT STRATEGIES ---

                        // A. Replace exact path reference (e.g., <img src="images/logo.png">)
                        // This uses a non-capturing group (?:) to optionally match ../ or ./
                        modifiedHtmlContent = modifiedHtmlContent.replace(
                            new RegExp(`(["'])(?:\\.{1,2}\/)*?${escapedPath}(["'])`, 'g'), 
                            `$1${htmlBlobURLs[originalPath]}$2`
                        );
                        
                        // B. Replace filename only reference (e.g., <script src="script.js">)
                        // This primarily covers assets in the same directory as the main HTML file.
                        // We avoid replacing if the path already contains an http/blob URL or is complex path.
                        modifiedHtmlContent = modifiedHtmlContent.replace(
                            new RegExp(`(["'])${escapedFileName}(["'])`, 'g'), 
                            (match, p1, p2) => {
                                // Check if this file is actually in the same directory path or if it has already been replaced (simple check)
                                if (originalPath === basePath + fileNameOnly) {
                                     // Ensure we haven't already replaced it with the blob URL in step A
                                    if (!match.includes('blob:')) {
                                        return `${p1}${htmlBlobURLs[originalPath]}${p2}`;
                                    }
                                }
                                return match; 
                            }
                        );
                    });


                    // Create a Blob for the modified HTML content
                    const modifiedHtmlBlob = new Blob([modifiedHtmlContent], { type: 'text/html' });
                    const url = URL.createObjectURL(modifiedHtmlBlob);
                    activeObjectUrls.push(url); // Store for later revocation

                    previewFrame.innerHTML = `
                        <div class="banner-container" id="bannerContainer">
                            <div class="banner-info" id="bannerInfo">Loading...</div>
                            <iframe class="banner-frame" id="bannerFrame" src="${url}"></iframe>
                        </div>
                    `;

                    const bannerFrame = document.getElementById('bannerFrame');
                    const bannerContainer = document.getElementById('bannerContainer');
                    const bannerInfo = document.getElementById('bannerInfo');

                    // Set minimum dimensions before loading
                    bannerFrame.style.width = '300px'; 
                    bannerFrame.style.height = '250px';
                    bannerContainer.style.width = '300px'; 
                    bannerContainer.style.height = '250px';

                    // Use setTimeout to ensure the iframe content has time to settle
                    bannerFrame.onload = () => {
                        setTimeout(() => {
                            let width = 300, height = 250;
                            try {
                                const frameDoc = bannerFrame.contentDocument || bannerFrame.contentWindow.document;
                                const body = frameDoc.body;
                                
                                // Try to get dimensions from document body or root elements
                                if (body && body.scrollWidth > 0 && body.scrollHeight > 0) {
                                    width = body.scrollWidth;
                                    height = body.scrollHeight;

                                    // Look for common banner div with style (e.g., Google Web Designer output)
                                    const adDiv = frameDoc.querySelector('div[style*="width:"][style*="height:"]');
                                    if (adDiv) {
                                        const styleWidth = parseInt(adDiv.style.width);
                                        const styleHeight = parseInt(adDiv.style.height);
                                        if (!isNaN(styleWidth)) width = styleWidth;
                                        if (!isNaN(styleHeight)) height = styleHeight;
                                    } else {
                                        // Fallback to meta viewport check for responsive banners
                                        const metaViewport = frameDoc.querySelector('meta[name="viewport"]');
                                        if (metaViewport && metaViewport.content) {
                                            const matchWidth = metaViewport.content.match(/width=(\d+)/);
                                            const matchHeight = metaViewport.content.match(/height=(\d+)/);
                                            if (matchWidth) width = parseInt(matchWidth[1]);
                                            if (matchHeight) height = parseInt(matchHeight[1]);
                                        }
                                    }

                                    // Apply dimensions
                                    bannerFrame.style.width = width + 'px';
                                    bannerFrame.style.height = height + 'px';
                                    bannerContainer.style.width = width + 'px';
                                    bannerContainer.style.height = height + 'px';
                                    bannerInfo.textContent = `${width} √ó ${height}`;
                                } else {
                                    // Fallback if dimensions are not easily found
                                    bannerInfo.textContent = 'Banner loaded (dimensions unknown/default)';
                                }

                            } catch (e) {
                                console.warn("Could not access iframe content (security/content loading issue):", e);
                                bannerInfo.textContent = 'Banner loaded (dimensions unknown/error)';
                            }
                        }, 50); // Small delay to let all assets and scripts run
                    };

                    bannerFrame.onerror = () => {
                        bannerInfo.textContent = 'Error loading banner';
                        console.error('Iframe failed to load content for:', filename);
                    };

                } catch (error) {
                    console.error('Error reading HTML content or creating blob URLs:', error);
                    previewFrame.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">‚ö†Ô∏è</div>
                            <div>Could not preview HTML file. Error processing content.</div>
                            <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                ${error.message}
                            </div>
                        </div>
                    `;
                }
            } else if (file.type === 'image') {
                // ... (existing image preview logic) ...
                const url = URL.createObjectURL(file.content);
                activeObjectUrls.push(url); 

                previewFrame.innerHTML = `
                    <div class="banner-container">
                        <div class="banner-info" id="bannerInfo">Loading image...</div>
                        <img id="previewImage" src="${url}" style="max-width: 100%; max-height: 100%; border: 1px solid #eee;">
                    </div>
                `;
                const previewImage = document.getElementById('previewImage');
                const bannerInfo = document.getElementById('bannerInfo');

                previewImage.onload = () => {
                    bannerInfo.textContent = `${previewImage.naturalWidth} √ó ${previewImage.naturalHeight} (Image Preview)`;
                };
                previewImage.onerror = () => {
                    bannerInfo.textContent = 'Error loading image';
                };
            } else {
                // For other file types
                previewFrame.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">${getFileIcon(file.type)}</div>
                        <div>${filename}</div>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                            ${(file.size / 1024).toFixed(1)} KB
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">
                            (Cannot preview this file type directly)
                        </div>
                    </div>
                `;
            }

            // Update button states
            const canPreview = isHtml || file.type === 'image';
            document.getElementById('refreshBtn').disabled = !canPreview;
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('fullscreenBtn').disabled = !isHtml;
            downloadWrapperBtn.disabled = !isHtml; // Only enable wrapper download for HTML files
        }

        function refreshPreview() {
            if (currentPreviewFile) {
                previewFile(currentPreviewFile);
                statusText.textContent = 'Preview refreshed';
            }
        }

        function clearAll() {
            // Menggunakan pesan box kustom sebagai ganti confirm()
            const customConfirm = document.createElement('div');
            customConfirm.style = "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background: white; border: 1px solid #0066B1; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000;";
            customConfirm.innerHTML = `
                <strong>Konfirmasi</strong>
                <p>Bersihkan semua file yang dimuat?</p>
                <div style="margin-top: 15px; text-align: right;">
                    <button id="confirmYes" style="padding: 5px 10px; background: #db1f25; color: white; border: none; border-radius: 4px; margin-right: 10px;">Ya</button>
                    <button id="confirmNo" style="padding: 5px 10px; background: #ccc; color: black; border: none; border-radius: 4px;">Tidak</button>
                </div>
            `;
            document.body.appendChild(customConfirm);

            document.getElementById('confirmYes').onclick = () => {
                customConfirm.remove();
                executeClearAll();
            };

            document.getElementById('confirmNo').onclick = () => {
                customConfirm.remove();
            };
        }

        function executeClearAll() {
            currentZip = null;
            currentFiles = {};
            currentPreviewFile = null;
            currentZipName = ''; // Reset ZIP name
            clearObjectUrls(); 

            filesList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üìÑ</div>
                    <div>No files loaded</div>
                </div>
            `;
            
            previewFrame.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üñºÔ∏è</div>
                    <div>Select an HTML file to preview</div>
                </div>
            `;
            
            previewTitle.textContent = 'Preview';
            fileInfo.style.display = 'none';
            
            // Disable all buttons
            document.getElementById('refreshBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = true;
            downloadWrapperBtn.disabled = true; // Disable new button
            document.getElementById('fullscreenBtn').disabled = true;
            
            statusText.textContent = 'Ready - Upload a ZIP file to start';
        }

        function downloadCurrentFile() {
            if (!currentPreviewFile) return;
            
            const file = currentFiles[currentPreviewFile];
            const url = URL.createObjectURL(file.content);
            activeObjectUrls.push(url); 
            
            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            setTimeout(() => URL.revokeObjectURL(url), 100); 
            statusText.textContent = `Downloaded ${file.name}`;
        }

        function openFullscreen() {
            if (!currentPreviewFile) return;
            
            const file = currentFiles[currentPreviewFile];
            if (file.type === 'html') {
                const url = URL.createObjectURL(file.content); 
                activeObjectUrls.push(url); 
                const newWindow = window.open(url, '_blank', 'width=800,height=600');
                
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                    const index = activeObjectUrls.indexOf(url);
                    if (index > -1) {
                        activeObjectUrls.splice(index, 1);
                    }
                }, 1000); 
            }
        }

        function resizeBanner(size) {
            const bannerFrame = document.getElementById('bannerFrame');
            const bannerContainer = document.getElementById('bannerContainer');
            if (!bannerFrame || !bannerContainer) return;
            
            const [width, height] = size.split('x').map(Number);
            bannerFrame.style.width = width + 'px';
            bannerFrame.style.height = height + 'px';
            bannerContainer.style.width = width + 'px';
            bannerContainer.style.height = height + 'px';
            
            const bannerInfo = document.getElementById('bannerInfo');
            if (bannerInfo) {
                bannerInfo.textContent = `${width} √ó ${height}`;
            }
        }

        function updateFileInfo(fileCount, zipSizeBytes) {
            totalFiles.textContent = fileCount;
            zipSize.textContent = (zipSizeBytes / 1024).toFixed(1) + ' KB';
            fileInfo.style.display = 'block';
        }

        function clearObjectUrls() {
            activeObjectUrls.forEach(url => URL.revokeObjectURL(url));
            activeObjectUrls = [];
        }

        window.addEventListener('beforeunload', clearObjectUrls);
    </script>
</body>
</html>
